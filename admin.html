<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Paneli</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; background: #181A20; color: #fff; margin: 0; }
    .admin-container { max-width: 500px; margin: 80px auto; background: #23242b; border-radius: 18px; box-shadow: 0 4px 24px rgba(67,24,255,0.10); padding: 40px 32px; text-align: center; }
    h1 { color: #05CD99; margin-bottom: 18px; }
    .logout-btn { background: #ff4d4f; color: #fff; border: none; border-radius: 8px; padding: 10px 24px; font-size: 16px; cursor: pointer; margin-top: 32px; }
  </style>
</head>
<body>
  <div class="admin-container" id="admin-content" style="display:none;">
    <h1>Admin Paneli</h1>
    <button class="logout-btn" id="back-profile-btn" style="background:#05CD99;margin-bottom:18px;">Profile'a Dön</button>
    <p>Hoşgeldin <span id="admin-email"></span>!</p>
    <p>Burada sadece adminlerin görebileceği özel içerikler yer alacak.</p>
    <div id="user-list"></div>
    <button class="logout-btn" id="logout-btn">Çıkış Yap</button>
  </div>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCRArf2VPbZuvLueY2qm2Lz9GhQXLvhzxY",
      authDomain: "rentcars-1077b.firebaseapp.com",
      projectId: "rentcars-1077b",
      storageBucket: "rentcars-1077b.appspot.com",
      messagingSenderId: "564934399024",
      appId: "1:564934399024:web:11dcb72be4d44e2a1709f5",
      measurementId: "G-DMX2083TNQ"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    // Rol hiyerarşisi
    const ROLES = ['owner', 'admin-orta', 'admin-alt', 'bayi'];
    const ROLE_LABELS = { 'owner': 'Owner', 'admin-orta': 'Orta Düzey', 'admin-alt': 'Alt Düzey', 'bayi': 'Bayi' };
    // Sadece adminler erişebilsin
    auth.onAuthStateChanged(async user => {
      if (!user) return window.location.href = 'login.html';
      // Kullanıcı Firestore'da admin mi kontrol et
      const userDoc = await db.collection('users').doc(user.uid).get();
      let myRole = 'admin-alt';
      if (user.email === 'mthnrsy@gmail.com') myRole = 'owner';
      else if (userDoc.exists && userDoc.data().role) myRole = userDoc.data().role;
      if (!ROLES.includes(myRole)) return window.location.href = 'login.html';
      document.getElementById('admin-content').style.display = 'block';
      document.getElementById('admin-email').textContent = user.email + ' (' + ROLE_LABELS[myRole] + ')';
      // Firestore'daki kullanıcıları çek ve listele
      const usersSnap = await db.collection('users').get();
      const users = usersSnap.docs.map(doc => ({
        uid: doc.id,
        email: doc.data().email,
        role: doc.data().role,
        banned: doc.data().banned
      }));
      // Listele
      const userListDiv = document.getElementById('user-list');
      userListDiv.innerHTML = '<h3>Kullanıcılar</h3>' +
        users.map(u => {
          const uid = u.uid;
          const email = u.email;
          let role = u.role || '';
          let roleLabel = ROLE_LABELS[role] || (email === 'mthnrsy@gmail.com' ? 'Owner' : 'Kullanıcı');
          let adminBadge = role ? `<b style='color:#05CD99'>(${roleLabel})</b>` : '';
          let buttons = '';
          // Ban durumu
          const banned = u.banned;
          // Hiyerarşiye göre atanabilir roller
          let assignableRoles = [];
          if (myRole === 'owner' && email !== user.email) assignableRoles = ROLES.filter(r => r !== role);
          else if (myRole === 'admin-orta' && email !== user.email && role !== 'owner') assignableRoles = ['admin-alt','bayi'].filter(r => r !== role);
          else if (myRole === 'admin-alt' && email !== user.email && role !== 'owner' && role !== 'admin-orta') assignableRoles = ['bayi'].filter(r => r !== role);
          // Rol seçme menüsü
          let roleSelect = '';
          if (assignableRoles.length && !banned) {
            roleSelect = `<select id='role-select-${uid}' style='margin-right:6px;'>` + assignableRoles.map(r => `<option value='${r}'>${ROLE_LABELS[r]}</option>`).join('') + `</select>`;
            buttons += `<button onclick=\"setRoleFromSelect('${uid}')\" style=\"background:#05CD99;color:#fff;border:none;border-radius:6px;padding:6px 10px;cursor:pointer;margin-right:8px;\">Rolü Ata</button>`;
          }
          // Ban butonu
          if (!banned && myRole !== 'bayi' && email !== user.email) {
            buttons += `<button onclick=\"banUser('${uid}')\" style=\"background:#ff4d4f;color:#fff;border:none;border-radius:6px;padding:6px 10px;cursor:pointer;\">Banla</button>`;
          }
          let banBadge = banned ? `<span style='color:#ff4d4f;font-weight:600;margin-left:8px;'>Banlı</span>` : '';
          return `<div style=\"display:flex;align-items:center;justify-content:space-between;margin:8px 0;padding:8px 0;border-bottom:1px solid #333;\">
            <span>${email} ${adminBadge} ${banBadge}</span>
            <span>${roleSelect}${buttons}</span>
          </div>`;
        }).join('');
    });
    window.setRole = async function(uid, role) {
      await db.collection('users').doc(uid).set({ role }, { merge: true });
      location.reload();
    };
    window.setRoleFromSelect = async function(uid) {
      const sel = document.getElementById('role-select-' + uid);
      if (!sel) return;
      const role = sel.value;
      await db.collection('users').doc(uid).set({ role }, { merge: true });
      location.reload();
    };
    window.banUser = async function(uid) {
      await db.collection('users').doc(uid).set({ banned: true }, { merge: true });
      location.reload();
    };
    document.getElementById('logout-btn').onclick = function() {
      auth.signOut().then(() => window.location.href = 'login.html');
    };
    document.getElementById('back-profile-btn').onclick = function() {
      window.location.href = 'profile.html';
    };
  </script>
</body>
</html> 