<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profil Paneli | Traveller</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <style>
    body { background: #F4F7FE; transition: background 0.3s; }
    .dark body { background: #181A20; }
    .panel-root { display: flex; min-height: 100vh; }
    .sidebar { width: 220px; background: #fff; border-radius: 0 24px 24px 0; box-shadow: 2px 0 16px rgba(67,24,255,0.06); padding: 40px 0 0 0; display: flex; flex-direction: column; align-items: center; transition: background 0.3s; }
    .dark .sidebar { background: #23242b; }
    .sidebar .avatar { width: 64px; height: 64px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; font-size: 32px; color: #4318FF; font-weight: 600; margin-bottom: 16px; }
    .dark .sidebar .avatar { background: #23242b; color: #fff; }
    .sidebar .name { font-size: 18px; font-weight: 600; margin-bottom: 32px; color: #222; }
    .dark .sidebar .name { color: #fff; }
    .sidebar .nav { width: 100%; display: flex; flex-direction: column; gap: 0; }
    .sidebar .nav-btn { width: 100%; background: none; border: none; text-align: left; padding: 16px 32px; font-size: 16px; color: #4318FF; cursor: pointer; border-left: 4px solid transparent; transition: background 0.2s, border-color 0.2s, color 0.3s; }
    .sidebar .nav-btn.active, .sidebar .nav-btn:hover { background: #F4F7FE; border-left: 4px solid #4318FF; }
    .dark .sidebar .nav-btn { color: #fff; }
    .dark .sidebar .nav-btn.active, .dark .sidebar .nav-btn:hover { background: #23242b; border-left: 4px solid #fff; }
    .sidebar .logout { margin-top: auto; margin-bottom: 32px; }
    .sidebar .logout-btn { background: #ff4d4f; color: #fff; border: none; border-radius: 8px; padding: 10px 24px; font-size: 16px; cursor: pointer; width: 80%; margin-left: 10%; }
    .panel-content { flex: 1; padding: 48px 40px; transition: background 0.3s, color 0.3s; }
    .dark .panel-content { background: #181A20; color: #fff; }
    .panel-section { display: none; max-width: 520px; margin: 0 auto; }
    .panel-section.active { display: block; }
    .profile-edit label { font-weight: 500; display: block; margin-bottom: 4px; }
    .profile-edit input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #E6E8F0; margin-bottom: 16px; font-size: 16px; background: #fff; color: #222; }
    .dark .profile-edit input { background: #23242b; color: #fff; border: 1px solid #333; }
    .btn-primary { background: #4318FF; color: #fff; border: none; border-radius: 8px; padding: 12px 0; font-size: 16px; cursor: pointer; width: 100%; }
    .cart-list { display: flex; flex-direction: column; gap: 16px; }
    .cart-card { background: #F4F7FE; border-radius: 12px; padding: 16px 20px; box-shadow: 0 2px 8px rgba(67,24,255,0.04); position: relative; }
    .dark .cart-card { background: #23242b; color: #fff; }
    .cart-card strong { font-size: 16px; }
    .cart-card span { color: #555; font-size: 15px; display: block; margin-top: 2px; }
    .dark .cart-card span, .dark .cart-card strong { color: #fff; }
    .cart-card .remove-btn { position: absolute; top: 16px; right: 16px; background: #ff4d4f; color: #fff; border: none; border-radius: 6px; padding: 6px 16px; cursor: pointer; }
    .payment-info { background: #F4F7FE; border-radius: 12px; padding: 24px 28px; box-shadow: 0 2px 8px rgba(67,24,255,0.04); }
    .dark .payment-info { background: #23242b; color: #fff; }
    .settings-section { background: #F4F7FE; border-radius: 12px; padding: 24px 28px; box-shadow: 0 2px 8px rgba(67,24,255,0.04); }
    .dark .settings-section { background: #23242b; color: #fff; }
    .switch { position: relative; display: inline-block; width: 48px; height: 28px; vertical-align: middle; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #4318FF; }
    input:checked + .slider:before { transform: translateX(20px); }
    .toast { position: fixed; top: -80px; left: 50%; transform: translateX(-50%); background: #4318FF; color: #fff; padding: 18px 36px; border-radius: 12px; font-size: 17px; font-weight: 500; box-shadow: 0 4px 24px rgba(67,24,255,0.12); z-index: 9999; opacity: 0; transition: top 0.5s, opacity 0.5s; }
    .toast.show { top: 32px; opacity: 1; }
    .car-list { display: flex; flex-direction: column; gap: 20px; }
    .car-card { display: flex; align-items: center; gap: 20px; background: #F4F7FE; border-radius: 14px; padding: 20px 24px; box-shadow: 0 2px 12px rgba(67,24,255,0.06); transition: background 0.3s, color 0.3s; }
    .car-card img { width: 110px; height: 80px; border-radius: 10px; object-fit: cover; background: #fff; }
    .car-info { flex: 1; }
    .car-info h3 { margin: 0 0 8px 0; font-size: 18px; color: #222; }
    .car-info span { color: #666; font-size: 15px; }
    .btn-rent { background: #4318FF; color: #fff; border: none; border-radius: 8px; padding: 10px 24px; font-size: 16px; cursor: pointer; margin-top: 8px; transition: background 0.2s; }
    .btn-rent:hover { background: #2d0fb2; }
    .no-cars { text-align: center; color: #888; margin-top: 32px; font-size: 18px; }
    .dark .car-card { background: #23242b; color: #fff; }
    .dark .car-info h3, .dark .car-info span { color: #fff; }
    .dark .btn-rent { background: #5a4fff; color: #fff; }
    .dark .btn-rent:hover { background: #2d0fb2; }
    .dark .no-cars { color: #bbb; }
    select, textarea { font-family: inherit; font-size: 16px; border-radius: 8px; border: 1px solid #E6E8F0; padding: 10px; margin-bottom: 12px; }
    .dark select, .dark textarea { background: #23242b; color: #fff; border: 1px solid #333; }
    .form-row { display: flex; flex-wrap: wrap; gap: 18px; margin-bottom: 14px; }
    .form-row > div { flex: 1 1 180px; min-width: 160px; }
    @media (max-width: 900px) {
      .form-row { flex-direction: column; gap: 10px; }
      .form-row > div { min-width: 0; }
    }
    .modern-form { background: var(--card, #fff); border-radius: 16px; box-shadow: 0 2px 12px rgba(67,24,255,0.06); padding: 28px 24px; margin-bottom: 24px; }
    .dark .modern-form { background: var(--card-dark, #23242b); }
    .modern-car-list .car-card { background: var(--card, #fff); border-radius: 16px; box-shadow: 0 2px 12px rgba(67,24,255,0.10); padding: 18px 24px; margin-bottom: 18px; display: flex; align-items: center; gap: 20px; transition: box-shadow 0.2s, background 0.2s; }
    .modern-car-list .car-card img { width: 110px; height: 80px; border-radius: 10px; object-fit: cover; background: #fff; }
    .modern-car-list .car-info { flex: 1; }
    .modern-car-list .car-info h3 { margin: 0 0 8px 0; font-size: 18px; color: #222; }
    .modern-car-list .car-info span { color: #666; font-size: 15px; }
    .dark .modern-car-list .car-card { background: var(--card-dark, #23242b); color: #fff; }
    .dark .modern-car-list .car-info h3, .dark .modern-car-list .car-info span { color: #fff; }
  </style>
</head>
<body>
  <div class="panel-root">
    <aside class="sidebar">
      <div class="avatar" id="profile-avatar">U</div>
      <div class="name" id="profile-name">Kullanıcı</div>
      <div class="nav">
        <button class="nav-btn active" id="tab-profile">Profilim</button>
        <button class="nav-btn" id="tab-cart">Araç Sepetim</button>
        <button class="nav-btn" id="tab-payment">Ödeme Bilgileri</button>
        <button class="nav-btn" id="tab-settings">Ayarlar</button>
        <button class="nav-btn" id="tab-rentout">Aracını Kiraya Ver</button>
        <button class="nav-btn" id="tab-findcar">Araç Bul</button>
      </div>
      <div class="logout">
        <button class="logout-btn" id="logout-btn">Çıkış Yap</button>
      </div>
    </aside>
    <main class="panel-content">
      <section class="panel-section active" id="section-profile">
        <h2>Profilim</h2>
        <form class="profile-edit" id="edit-form">
          <label for="edit-email">E-posta</label>
          <input type="email" id="edit-email" disabled>
          <label for="edit-name">Ad Soyad</label>
          <input type="text" id="edit-name">
          <label for="edit-password">Yeni Şifre</label>
          <input type="password" id="edit-password" placeholder="Şifreyi değiştirmek için doldurun">
          <button class="btn-primary" type="submit">Kaydet</button>
        </form>
      </section>
      <section class="panel-section" id="section-cart">
        <h2>Araç Sepetim</h2>
        <div class="cart-list" id="cart-list"></div>
      </section>
      <section class="panel-section" id="section-payment">
        <h2>Ödeme Bilgileri</h2>
        <div class="payment-info">
          <p>Henüz ödeme bilgisi eklenmedi.</p>
          <p>Bu alanı dilediğin gibi özelleştirebiliriz.</p>
        </div>
      </section>
      <section class="panel-section" id="section-settings">
        <h2>Ayarlar</h2>
        <div class="settings-section">
          <label style="font-size:16px;display:flex;align-items:center;gap:16px;">
            <span>Koyu Tema</span>
            <label class="switch">
              <input type="checkbox" id="theme-toggle">
              <span class="slider"></span>
            </label>
          </label>
        </div>
      </section>
      <section class="panel-section" id="section-rentout">
        <h2>Aracını Kiraya Ver</h2>
        <form id="rentout-form" class="settings-section modern-form" enctype="multipart/form-data">
          <div class="form-row">
            <div><label>Marka</label><select id="car-brand" required></select></div>
            <div><label>Model</label><input type="text" id="car-model" required></div>
          </div>
          <div class="form-row">
            <div><label>Yıl</label><input type="number" id="car-year" min="1980" max="2024" required></div>
            <div><label>Vites Tipi</label>
              <select id="car-gear" required>
                <option value="">Seçiniz</option>
                <option value="Otomatik">Otomatik</option>
                <option value="Manuel">Manuel</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div><label>Şehir</label><select id="car-city" required><option value="">Şehir seçin</option></select></div>
            <div><label>İlçe</label><select id="car-district" required><option value="">İlçe seçin</option></select></div>
          </div>
          <div class="form-row">
            <div><label>Fiyat (₺/gün)</label><input type="number" id="car-price" min="1" required></div>
            <div><label>Fotoğraf (isteğe bağlı)</label><input type="file" id="car-img" accept="image/*"></div>
          </div>
          <label>Açıklama</label>
          <textarea id="car-desc" rows="2"></textarea>
          <button class="btn-primary" type="submit" style="margin-top:16px;">Aracı Ekle</button>
        </form>
      </section>
      <section class="panel-section" id="section-findcar">
        <h2>Araç Bul</h2>
        <form class="booking-form modern-form" id="findcar-form">
          <div class="form-row">
            <div><label for="findcar-city">Şehir</label><select id="findcar-city" required><option value="">Şehir seçin</option></select></div>
            <div><label for="findcar-district">İlçe</label><select id="findcar-district" required><option value="">İlçe seçin</option></select></div>
          </div>
          <div class="form-row">
            <div><label for="findcar-brand">Marka</label><select id="findcar-brand"><option value="">Hepsi</option></select></div>
            <div><label for="findcar-model">Model</label><input type="text" id="findcar-model" placeholder="Opsiyonel"></div>
          </div>
          <div class="form-row">
            <div><label for="findcar-year">Yıl</label><input type="number" id="findcar-year" min="1980" max="2024" placeholder="Opsiyonel"></div>
            <div><label for="findcar-gear">Vites Tipi</label>
              <select id="findcar-gear"><option value="">Hepsi</option><option value="Otomatik">Otomatik</option><option value="Manuel">Manuel</option></select>
            </div>
          </div>
          <div class="form-row">
            <div><label for="findcar-price-min">Min Fiyat</label><input type="number" id="findcar-price-min" min="0" placeholder="₺"></div>
            <div><label for="findcar-price-max">Max Fiyat</label><input type="number" id="findcar-price-max" min="0" placeholder="₺"></div>
          </div>
          <div class="form-row">
            <div><label for="findcar-pickup">Alış Tarihi</label><input type="date" id="findcar-pickup" required></div>
            <div><label for="findcar-dropoff">İade Tarihi</label><input type="date" id="findcar-dropoff" required></div>
          </div>
        </form>
        <div class="car-list modern-car-list" id="findcar-list"></div>
        <div class="no-cars" id="findcar-nocars" style="display:none;">Bölgenizde uygun araç bulunamadı.</div>
      </section>
    </main>
  </div>
  <div class="toast" id="toast"></div>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="sehir-ilce-data.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCRArf2VPbZuvLueY2qm2Lz9GhQXLvhzxY",
      authDomain: "rentcars-1077b.firebaseapp.com",
      projectId: "rentcars-1077b",
      storageBucket: "rentcars-1077b.appspot.com",
      messagingSenderId: "564934399024",
      appId: "1:564934399024:web:11dcb72be4d44e2a1709f5",
      measurementId: "G-DMX2083TNQ"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    // Sidebar ve kullanıcı bilgileri
    const nameEl = document.getElementById('profile-name');
    const avatarEl = document.getElementById('profile-avatar');
    const editForm = document.getElementById('edit-form');
    const editEmail = document.getElementById('edit-email');
    const editName = document.getElementById('edit-name');
    const editPassword = document.getElementById('edit-password');
    const logoutBtn = document.getElementById('logout-btn');
    // Sekmeler
    const tabProfile = document.getElementById('tab-profile');
    const tabCart = document.getElementById('tab-cart');
    const tabPayment = document.getElementById('tab-payment');
    const tabSettings = document.getElementById('tab-settings');
    const tabRentout = document.getElementById('tab-rentout');
    const tabFindcar = document.getElementById('tab-findcar');
    const sectionProfile = document.getElementById('section-profile');
    const sectionCart = document.getElementById('section-cart');
    const sectionPayment = document.getElementById('section-payment');
    const sectionSettings = document.getElementById('section-settings');
    const sectionRentout = document.getElementById('section-rentout');
    const sectionFindcar = document.getElementById('section-findcar');
    // Toast
    const toast = document.getElementById('toast');
    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => { toast.classList.remove('show'); }, 2200);
    }
    // Koyu tema
    const themeToggle = document.getElementById('theme-toggle');
    function setTheme(dark) {
      if (dark) {
        document.documentElement.classList.add('dark');
        localStorage.setItem('theme', 'dark');
      } else {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('theme', 'light');
      }
    }
    themeToggle.onchange = () => setTheme(themeToggle.checked);
    // Tema ilk yükleme
    if (localStorage.getItem('theme') === 'dark') {
      document.documentElement.classList.add('dark');
      themeToggle.checked = true;
    }
    // Auth
    auth.onAuthStateChanged(user => {
      if (user) {
        nameEl.textContent = user.displayName || 'Kullanıcı';
        avatarEl.textContent = (user.displayName ? user.displayName[0] : 'U').toUpperCase();
        editEmail.value = user.email;
        editName.value = user.displayName || '';
      } else {
        window.location.href = 'login.html';
      }
    });
    // Sekme geçişleri
    function setTab(tab) {
      [tabProfile, tabCart, tabPayment, tabSettings, tabRentout, tabFindcar].forEach(btn => btn.classList.remove('active'));
      [sectionProfile, sectionCart, sectionPayment, sectionSettings, sectionRentout, sectionFindcar].forEach(sec => sec.classList.remove('active'));
      if (tab === 'profile') { tabProfile.classList.add('active'); sectionProfile.classList.add('active'); }
      if (tab === 'cart') { tabCart.classList.add('active'); sectionCart.classList.add('active'); renderCart(); }
      if (tab === 'payment') { tabPayment.classList.add('active'); sectionPayment.classList.add('active'); }
      if (tab === 'settings') { tabSettings.classList.add('active'); sectionSettings.classList.add('active'); }
      if (tab === 'rentout') {
        tabRentout.classList.add('active'); sectionRentout.classList.add('active');
        fillCitySelect('car-city', 'car-district');
      }
      if (tab === 'findcar') {
        tabFindcar.classList.add('active'); sectionFindcar.classList.add('active');
        fillCitySelect('findcar-city', 'findcar-district');
        renderFindCars();
      }
    }
    tabProfile.onclick = () => setTab('profile');
    tabCart.onclick = () => setTab('cart');
    tabPayment.onclick = () => setTab('payment');
    tabSettings.onclick = () => setTab('settings');
    tabRentout.onclick = () => setTab('rentout');
    tabFindcar.onclick = () => setTab('findcar');
    // Profil düzenleme
    editForm.onsubmit = async (e) => {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) return;
      const newName = editName.value.trim();
      const newPassword = editPassword.value.trim();
      try {
        if (newName && newName !== user.displayName) {
          await user.updateProfile({ displayName: newName });
          nameEl.textContent = newName;
          avatarEl.textContent = newName[0].toUpperCase();
        }
        if (newPassword.length >= 6) {
          await user.updatePassword(newPassword);
        }
        showToast('Profil güncellendi!');
        editPassword.value = '';
      } catch (err) {
        showToast('Hata: ' + err.message);
      }
    };
    logoutBtn.onclick = () => { auth.signOut().then(() => { window.location.href = 'login.html'; }); };
    // Sepet/kiralama geçmişini göster
    function renderCart() {
      const cart = JSON.parse(localStorage.getItem('cart') || '[]');
      const cartList = document.getElementById('cart-list');
      if (!cart.length) {
        cartList.innerHTML = '<em>Sepetiniz boş.</em>';
        return;
      }
      cartList.innerHTML = cart.map((item, idx) => {
        // Firestore'dan gelen araçlarda car.brand ve car.model var
        const carName = item.car.name || (item.car.brand ? `${item.car.brand} ${item.car.model}` : '-');
        return `
          <div class="cart-card">
            <strong>${carName}</strong>
            <span>Şehir: ${item.city || '-'} | İlçe: ${item.district || '-'}</span>
            <span>Alış: ${item.pickup}</span>
            <span>İade: ${item.dropoff}</span>
            <span>Fiyat: ${item.car.price} ₺/gün</span>
            <button class="remove-btn" onclick="removeFromCart(${idx})">Kaldır</button>
          </div>
        `;
      }).join('');
    }
    window.removeFromCart = function(idx) {
      const cart = JSON.parse(localStorage.getItem('cart') || '[]');
      cart.splice(idx, 1);
      localStorage.setItem('cart', JSON.stringify(cart));
      renderCart();
      showToast('Araç sepetten kaldırıldı!');
    }
    // İlk yüklemede profil sekmesi aktif olsun
    setTab('profile');
    // Aracını Kiraya Ver formu
    const rentoutForm = document.getElementById('rentout-form');
    rentoutForm.onsubmit = async function(e) {
      e.preventDefault();
      const brand = document.getElementById('car-brand').value.trim();
      const model = document.getElementById('car-model').value.trim();
      const year = document.getElementById('car-year').value.trim();
      const city = document.getElementById('car-city').value;
      const district = document.getElementById('car-district').value;
      const price = document.getElementById('car-price').value.trim();
      const desc = document.getElementById('car-desc').value.trim();
      const gear = document.getElementById('car-gear').value;
      const imgInput = document.getElementById('car-img');
      let imgData = '';
      if (imgInput.files && imgInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function(evt) {
          imgData = evt.target.result;
          saveCar();
        };
        reader.readAsDataURL(imgInput.files[0]);
      } else {
        saveCar();
      }
      async function saveCar() {
        try {
          await db.collection('cars').add({ brand, model, year, city, district, price, desc, gear, img: imgData, createdAt: new Date() });
          showToast('Araç başarıyla eklendi!');
          rentoutForm.reset();
        } catch (err) {
          showToast('Hata: ' + err.message);
        }
      }
    };
    // Tüm markalar ve popüler modeller
    const MARKA_MODELLER = {
      "Renault": ["Clio", "Megane", "Symbol", "Talisman", "Captur", "Kadjar"],
      "Fiat": ["Egea", "Linea", "Panda", "500", "Doblo", "Fiorino"],
      "Ford": ["Focus", "Fiesta", "Mondeo", "Kuga", "Tourneo", "Transit"],
      "Volkswagen": ["Golf", "Polo", "Passat", "Tiguan", "Jetta", "Caddy"],
      "Toyota": ["Corolla", "Yaris", "Auris", "Camry", "RAV4", "Hilux"],
      "Hyundai": ["i20", "i10", "Accent", "Elantra", "Tucson", "Kona"],
      "Peugeot": ["208", "308", "3008", "2008", "508", "Partner"],
      "Opel": ["Astra", "Corsa", "Insignia", "Mokka", "Crossland", "Combo"],
      "Honda": ["Civic", "Jazz", "Accord", "CR-V", "HR-V"],
      "Citroen": ["C3", "C4", "C5", "Berlingo", "C-Elysee"],
      "BMW": ["1 Serisi", "3 Serisi", "5 Serisi", "X1", "X3", "X5"],
      "Mercedes": ["A Serisi", "C Serisi", "E Serisi", "GLA", "GLC", "Vito"],
      "Nissan": ["Qashqai", "Juke", "Micra", "X-Trail", "Navara"],
      "Kia": ["Rio", "Ceed", "Sportage", "Picanto", "Sorento"],
      "Seat": ["Ibiza", "Leon", "Arona", "Ateca", "Toledo"],
      "Skoda": ["Octavia", "Superb", "Fabia", "Karoq", "Kodiaq"],
      "Audi": ["A3", "A4", "A6", "Q3", "Q5", "Q7"],
      "Mazda": ["3", "6", "CX-3", "CX-5"],
      "Dacia": ["Duster", "Sandero", "Lodgy", "Logan"],
      "Mini": ["Cooper", "Countryman", "Clubman"],
      "Volvo": ["S60", "S90", "XC40", "XC60", "XC90"],
      "Suzuki": ["Swift", "Vitara", "SX4"],
      "Mitsubishi": ["Lancer", "ASX", "Outlander"],
      "Chevrolet": ["Aveo", "Cruze", "Captiva"],
      "Subaru": ["Impreza", "Forester", "XV"],
      "Jeep": ["Renegade", "Compass", "Cherokee"],
      "Alfa Romeo": ["Giulietta", "Stelvio", "Mito"],
      "Porsche": ["Cayenne", "Macan", "Panamera"],
      "Land Rover": ["Range Rover", "Discovery", "Evoque"],
      "Tesla": ["Model S", "Model 3", "Model X", "Model Y"],
      "Lexus": ["IS", "ES", "RX", "NX"],
      "Jaguar": ["XE", "XF", "F-Pace"],
      "Peugeot": ["208", "308", "3008", "2008", "508", "Partner"],
      "Chery": ["Tiggo 8", "Tiggo 7", "Arrizo 5"]
    };
    const MARKA_LIST = Object.keys(MARKA_MODELLER);
    function fillBrandSelect(selectId, withAllOpt) {
      const sel = document.getElementById(selectId);
      sel.innerHTML = '';
      if (withAllOpt) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'Hepsi';
        sel.appendChild(opt);
      }
      MARKA_LIST.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m;
        opt.textContent = m;
        sel.appendChild(opt);
      });
    }
    function fillModelSelect(selectId, brand, withAllOpt) {
      const sel = document.getElementById(selectId);
      sel.innerHTML = '';
      if (withAllOpt) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'Hepsi';
        sel.appendChild(opt);
      }
      if (brand && MARKA_MODELLER[brand]) {
        MARKA_MODELLER[brand].forEach(model => {
          const opt = document.createElement('option');
          opt.value = model;
          opt.textContent = model;
          sel.appendChild(opt);
        });
      }
    }
    fillBrandSelect('car-brand', false);
    fillBrandSelect('findcar-brand', true);
    fillModelSelect('car-model', MARKA_LIST[0], false);
    fillModelSelect('findcar-model', '', true);
    document.getElementById('car-brand').onchange = function() {
      fillModelSelect('car-model', this.value, false);
    };
    document.getElementById('findcar-brand').onchange = function() {
      fillModelSelect('findcar-model', this.value, true);
      renderFindCars();
    };
    async function renderFindCars() {
      const city = document.getElementById('findcar-city').value;
      const district = document.getElementById('findcar-district').value;
      const brand = document.getElementById('findcar-brand').value;
      const model = document.getElementById('findcar-model').value;
      const year = document.getElementById('findcar-year').value.trim();
      const gear = document.getElementById('findcar-gear').value;
      const priceMin = parseInt(document.getElementById('findcar-price-min').value, 10);
      const priceMax = parseInt(document.getElementById('findcar-price-max').value, 10);
      const carList = document.getElementById('findcar-list');
      const noCars = document.getElementById('findcar-nocars');
      let query = db.collection('cars');
      if (city) query = query.where('city', '==', city);
      if (district) query = query.where('district', '==', district);
      const snapshot = await query.get();
      let cars = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      // Ek filtreler
      if (brand) cars = cars.filter(car => (car.brand || '') === brand);
      if (model) cars = cars.filter(car => (car.model || '') === model);
      if (year) cars = cars.filter(car => String(car.year) === year);
      if (gear) cars = cars.filter(car => car.gear === gear);
      if (!isNaN(priceMin)) cars = cars.filter(car => parseInt(car.price, 10) >= priceMin);
      if (!isNaN(priceMax)) cars = cars.filter(car => parseInt(car.price, 10) <= priceMax);
      let filtered = cars;
      if (!city) filtered = [];
      if (filtered.length === 0) {
        carList.innerHTML = '';
        noCars.style.display = 'block';
        return;
      }
      noCars.style.display = 'none';
      carList.innerHTML = filtered.map((car, i) => `
        <div class="car-card">
          ${car.img ? `<img src="${car.img}" alt="${car.brand} ${car.model}">` : ''}
          <div class="car-info">
            <h3>${car.brand} ${car.model} (${car.year})</h3>
            <span>${car.gear} | ${car.city}, ${car.district}</span><br>
            <span>Fiyat: ${car.price} ₺/gün</span><br>
            <span>${car.desc || ''}</span>
          </div>
          <button class="btn-rent" onclick="addToCartFromFindFirestore('${car.id}')">Sepete Ekle</button>
        </div>
      `).join('');
    }
    window.addToCartFromFindFirestore = async function(carId) {
      const city = document.getElementById('findcar-city').value;
      const district = document.getElementById('findcar-district').value;
      const pickup = document.getElementById('findcar-pickup').value;
      const dropoff = document.getElementById('findcar-dropoff').value;
      if (!city || !district || !pickup || !dropoff) {
        showToast('Lütfen şehir, ilçe ve tarihleri doldurun!');
        return;
      }
      const doc = await db.collection('cars').doc(carId).get();
      const car = doc.data();
      if (!car) return;
      let cart = JSON.parse(localStorage.getItem('cart') || '[]');
      if (cart.some(item => item.carId === carId)) {
        showToast('Bu araç zaten sepette!');
        return;
      }
      cart.push({carId, car, city, district, pickup, dropoff});
      localStorage.setItem('cart', JSON.stringify(cart));
      showToast('Araç sepete eklendi!');
    };
    // Araç ekleme ve bulma formlarında şehir/ilçe select menüleri
    function fillCitySelect(cityId, districtId) {
      const citySelect = document.getElementById(cityId);
      const districtSelect = document.getElementById(districtId);
      if (!citySelect || !districtSelect) return;
      citySelect.innerHTML = '';
      const defaultOpt = document.createElement('option');
      defaultOpt.value = '';
      defaultOpt.textContent = 'Şehir seçin';
      citySelect.appendChild(defaultOpt);
      window.TURKEY_CITIES.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.name;
        opt.textContent = c.name;
        citySelect.appendChild(opt);
      });
      citySelect.onchange = function() {
        const city = window.TURKEY_CITIES.find(c => c.name === citySelect.value);
        districtSelect.innerHTML = '';
        const defaultDist = document.createElement('option');
        defaultDist.value = '';
        defaultDist.textContent = 'İlçe seçin';
        districtSelect.appendChild(defaultDist);
        if (city) {
          city.districts.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d;
            opt.textContent = d;
            districtSelect.appendChild(opt);
          });
        }
      };
      // İlçe select'i de sıfırla
      districtSelect.innerHTML = '';
      const defaultDist = document.createElement('option');
      defaultDist.value = '';
      defaultDist.textContent = 'İlçe seçin';
      districtSelect.appendChild(defaultDist);
    }
    // Sayfa yüklenince bir kez doldur
    fillCitySelect('car-city', 'car-district');
    fillCitySelect('findcar-city', 'findcar-district');
    // Araç bulma formunda şehir/ilçe ve diğer filtreler değişince Firestore'dan çek
    ['findcar-city','findcar-district','findcar-brand','findcar-model','findcar-year','findcar-gear','findcar-price-min','findcar-price-max'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.onchange = renderFindCars;
      if (el && el.tagName === 'INPUT') el.oninput = renderFindCars;
    });
    // Sayfa ilk açıldığında araçları çek
    renderFindCars();
  </script>
</body>
</html> 